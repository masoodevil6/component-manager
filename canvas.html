<!--<svg id="mysvg" width="400" height="200" style="border:1px solid #ccc"></svg>

<script>
  // Ù…Ø®ØªØµØ§Øª Ø³Ù‡ Ù†Ù‚Ø·Ù‡
  const points = [
    { x: 50,  y: 150 },
    { x: 200, y: 50  },
    { x: 350, y: 150 }
  ];

  const svg = document.getElementById("mysvg");

  // Ø³Ø§Ø®Øª Ø®Ø· (polyline)
  const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
  polyline.setAttribute("points", points.map(p => `${p.x},${p.y}`).join(" "));
  polyline.setAttribute("stroke", "black");
  polyline.setAttribute("stroke-width", "2");
  polyline.setAttribute("fill", "none");
  svg.appendChild(polyline);

  // Ø³Ø§Ø®Øª Ø¯Ø§ÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†Ù‚Ø·Ù‡
  points.forEach(p => {
    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    circle.setAttribute("cx", p.x);
    circle.setAttribute("cy", p.y);
    circle.setAttribute("r", 5);
    circle.setAttribute("fill", "red");
    svg.appendChild(circle);
  });
</script>-->








<!--<svg id="mysvg2" width="400" height="200" style="border:1px solid #ccc"></svg>

<script>
  // Ø³Ù‡ Ù†Ù‚Ø·Ù‡
  const points = [
    { x: 50,  y: 150 },
    { x: 200, y: 50  },
    { x: 350, y: 150 }
  ];

  const svg = document.getElementById("mysvg2");

  // Ù…Ø³ÛŒØ± Ù…Ù†Ø­Ù†ÛŒ (Cubic Bezier)
  const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
  const d = `M ${points[0].x},${points[0].y}
             Q ${points[1].x},${points[1].y}
               ${points[2].x},${points[2].y}`;
  path.setAttribute("d", d);
  path.setAttribute("stroke", "black");
  path.setAttribute("stroke-width", "2");
  path.setAttribute("fill", "none");
  svg.appendChild(path);

  // Ù†Ù…Ø§ÛŒØ´ Ø³Ù‡ Ù†Ù‚Ø·Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø§ÛŒØ±Ù‡
  points.forEach(p => {
    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    circle.setAttribute("cx", p.x);
    circle.setAttribute("cy", p.y);
    circle.setAttribute("r", 5);
    circle.setAttribute("fill", "red");
    svg.appendChild(circle);
  });
</script>-->







<!--<svg id="mysvg2" width="1500" height="1500" style="border:1px solid #ccc"></svg>

<script>
  // Ø³Ù‡ Ù†Ù‚Ø·Ù‡
  const points = [
    { x: 0,  y: 0 },
    { x: 450, y: 360  },
    { x: 500, y: 400 } ,
    { x: 550,  y: 360 },
    { x: 1000, y: 0  }
  ];

  const svg = document.getElementById("mysvg2");


  const polyline1 = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
  polyline1.setAttribute("points", `${points[0].x},${points[0].y}  ${points[1].x},${points[1].y}`);
  polyline1.setAttribute("stroke", "black");
  polyline1.setAttribute("stroke-width", "2");
  polyline1.setAttribute("fill", "none");
  svg.appendChild(polyline1);

  const polyline2 = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
  polyline2.setAttribute("points", `${points[3].x},${points[3].y}  ${points[4].x},${points[4].y}`);
  polyline2.setAttribute("stroke", "black");
  polyline2.setAttribute("stroke-width", "2");
  polyline2.setAttribute("fill", "none");
  svg.appendChild(polyline2);


  const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
  const d = `M ${points[1].x},${points[1].y}
             Q ${points[2].x},${points[2].y}
               ${points[3].x},${points[3].y}`;
  path.setAttribute("d", d);
  path.setAttribute("stroke", "black");
  path.setAttribute("stroke-width", "2");
  path.setAttribute("fill", "none");
  svg.appendChild(path);


  // Ù†Ù…Ø§ÛŒØ´ Ø³Ù‡ Ù†Ù‚Ø·Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø§ÛŒØ±Ù‡
  points.forEach(p => {
    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    circle.setAttribute("cx", p.x);
    circle.setAttribute("cy", p.y);
    circle.setAttribute("r", 5);
    circle.setAttribute("fill", "red");
    svg.appendChild(circle);
  });

</script>-->



<!--<svg id="mysvg" width="400" height="200" style="border:1px solid #ccc"></svg>

<script>
  const svg = document.getElementById("mysvg");

  // Ø³Ù‡ Ù†Ù‚Ø·Ù‡ Ù†Ù…ÙˆÙ†Ù‡
  const points = [
    { x: 50,  y: 150 },
    { x: 200, y: 50  },
    { x: 350, y: 150 }
  ];

  // Ø³Ø§Ø®Øª Ø¯Ø§ÛŒØ±Ù‡â€ŒÙ‡Ø§
  points.forEach((p, i) => {
    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    circle.setAttribute("cx", p.x);
    circle.setAttribute("cy", p.y);
    circle.setAttribute("r", 8);
    circle.setAttribute("fill", "red");
    circle.style.cursor = "pointer";
    svg.appendChild(circle);

    // drag callback
    let isDragging = false;

    circle.addEventListener("mousedown", (e) => {
      isDragging = true;
    });

    svg.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      // Ù…Ø®ØªØµØ§Øª Ù…ÙˆØ³ Ù†Ø³Ø¨Øª Ø¨Ù‡ SVG
      const pt = svg.createSVGPoint();
      pt.x = e.clientX;
      pt.y = e.clientY;
      const cursorpt = pt.matrixTransform(svg.getScreenCTM().inverse());

      // Ø¨Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø§ÛŒØ±Ù‡
      circle.setAttribute("cx", cursorpt.x);
      circle.setAttribute("cy", cursorpt.y);

      // Ú©Ø§Ù„ Ø¨Ú©: Ù…Ø«Ù„Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ù…Ø®ØªØµØ§Øª Ø¬Ø¯ÛŒØ¯ Ø±Ùˆ Ú†Ø§Ù¾ Ú©Ù†ÛŒ
      console.log(`Point ${i}: x=${cursorpt.x}, y=${cursorpt.y}`);
    });

    document.addEventListener("mouseup", () => {
      isDragging = false;
    });
  });
</script>-->




<!--<svg id="mysvg" width="400" height="200" style="border:1px solid #ccc">

  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="black" />
    </marker>

    <marker id="arrow2" markerWidth="10" markerHeight="10" refX="3" refY="3" orient="auto">
      <path d="M0,0 L3,3 L0,6 L9,3 z" fill="black" />
    </marker>
  </defs>


</svg>

<script>
  // Ù…Ø®ØªØµØ§Øª Ø³Ù‡ Ù†Ù‚Ø·Ù‡
  const points = [
    { x: 50,  y: 150 },
    { x: 200, y: 50  }
  ];

  const svg = document.getElementById("mysvg");

  // Ø³Ø§Ø®Øª Ø®Ø· (polyline)
  const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
  polyline.setAttribute("points", points.map(p => `${p.x},${p.y}`).join(" "));
  polyline.setAttribute("stroke", "black");
  polyline.setAttribute("stroke-width", "2");
  polyline.setAttribute("fill", "none");
  polyline.setAttribute("marker-end", "url(#arrow2)");
  svg.appendChild(polyline);

 /* // Ø³Ø§Ø®Øª Ø¯Ø§ÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†Ù‚Ø·Ù‡
  points.forEach(p => {
    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    circle.setAttribute("cx", p.x);
    circle.setAttribute("cy", p.y);
    circle.setAttribute("r", 5);
    circle.setAttribute("fill", "red");
    svg.appendChild(circle);
  });*/
</script>-->



<!--<svg id="mysvg" width="400" height="200" style="border:1px solid #ccc"></svg>

<script>
  const svg = document.getElementById("mysvg");

  // Ø³Ø§Ø®Øª foreignObject
  const foreign = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
  foreign.setAttribute("x", 100);   // Ù…Ø®ØªØµØ§Øª X
  foreign.setAttribute("y", 100);   // Ù…Ø®ØªØµØ§Øª Y
  foreign.setAttribute("width", 120);
  foreign.setAttribute("height", 50);

  // Ø³Ø§Ø®Øª ÛŒÚ© div Ø¯Ø§Ø®Ù„ foreignObject
  const div = document.createElement("div");
  div.setAttribute("xmlns", "http://www.w3.org/1999/xhtml"); // Ù…Ù‡Ù… Ø¨Ø±Ø§ÛŒ HTML Ø¯Ø§Ø®Ù„ SVG
  div.style.fontSize = "14px";
  div.style.color = "blue";
  div.innerText = "Ø³Ù„Ø§Ù… ğŸ‘‹ Ù…ØªÙ† HTML Ø¯Ø§Ø®Ù„ SVG";

  // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† div Ø¨Ù‡ foreignObject
  foreign.appendChild(div);

  // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† foreignObject Ø¨Ù‡ SVG
  svg.appendChild(foreign);
</script>-->





<svg id="mysvg" width="2000" height="2000" style="border:1px solid #ccc">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="3" refY="3" orient="auto">
      <path d="M0,0 L3,3 L0,6 L9,3 z" fill="black" />
    </marker>
  </defs>

</svg>

<script>

  function getPointInLinWithPercent(pointA , pointB , isStart=true , percent=0.1){
    return {
      x: (isStart ? percent : (1-percent)) * (pointB.x - pointA.x) + pointA.x ,
      y: (isStart ? percent : (1-percent)) * (pointB.y - pointA.y) + pointA.y ,
    }
  }

  function getPointInLinWithLength(pointA , pointB , isStart=true , length=10){
    const d = Math.sqrt(Math.pow(pointB.x - pointA.x, 2) + Math.pow(pointB.y - pointA.y, 2));
    const p = length/d;
    return getPointInLinWithPercent(pointA , pointB , isStart , p);
  }

  function connectTreeYPoint(svgId , points , lineWidth=2){
    const svg = document.getElementById(svgId);

    const pointsProgressed = [];
    if (points != null && Array.isArray(points)){
      for (let i = 0; i < points.length ; i++) {
        const pointSelected = points[i];

        let isJoin = true;
        if (i == 0 || i == points.length -1){
          isJoin = false;
        }

        if (isJoin){
          const pointAB = getPointInLinWithLength(points[i-1] , points[i]  , false);
          pointSelected.isJoin = true;
          const pointBC = getPointInLinWithLength(points[i]  , points[i+1] , true);
          pointsProgressed.push(...[pointAB , pointSelected , pointBC])
        }
        else {
          pointsProgressed.push(pointSelected)
        }
      }
    }

    for (let i = 0; i < pointsProgressed.length-1 ; i++) {
      const pointPrevious = pointsProgressed[i-1];
      const pointSelected = pointsProgressed[i];
      const pointNext = pointsProgressed[i+1];

      if (!pointNext.hasOwnProperty("isJoin") || !pointNext.isJoin){
        if (pointSelected.hasOwnProperty("isJoin") && pointSelected.isJoin){
          const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
          const d = `M ${pointPrevious.x},${pointPrevious.y}
             Q ${pointSelected.x},${pointSelected.y}
               ${pointNext.x},${pointNext.y}`;
          path.setAttribute("d", d);
          path.setAttribute("stroke", "black");
          path.setAttribute("stroke-width", lineWidth);
          path.setAttribute("fill", "none");
          svg.appendChild(path);
        }
        else {
          const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
          polyline.setAttribute("points", `${pointSelected.x},${pointSelected.y}  ${pointNext.x},${pointNext.y}`);
          polyline.setAttribute("stroke", "black");
          polyline.setAttribute("stroke-width", lineWidth);
          polyline.setAttribute("fill", "none");
          if (pointNext.hasOwnProperty("hasArrow") && pointNext.hasArrow){
            polyline.setAttribute("marker-end", "url(#arrow)");
          }
          svg.appendChild(polyline);
        }
      }
    }
  }

  function createHtmlOnPoint(svgId , html , point){
    const svg = document.getElementById(svgId);

    const foreign = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
    foreign.setAttribute("x", point.x);   // Ù…Ø®ØªØµØ§Øª X
    foreign.setAttribute("y", point.y);   // Ù…Ø®ØªØµØ§Øª Y
    foreign.setAttribute("width", point.width);
    foreign.setAttribute("height", point.height);

    foreign.innerHTML=html

    svg.appendChild(foreign);
  }

  function connectTwoPointWithTreeHierarchy(svgId , objectA , objectB , LYmin=20){

    let points = null
    if (objectB.y >= objectA.y + LYmin){
      const mid = ((objectB.y - objectA.y)/2);
      points = [
        { x: objectA.x , y: objectA.y                      } ,
        { x: objectA.x , y: objectA.y + mid                } ,
        { x: objectB.x , y: objectB.y - mid                } ,
        { x: objectB.x , y: objectB.y       , hasArrow:true}
      ]
    }
    else{
      const mid = ((objectB.x - objectA.x)/2);
      points = [
        {x: objectA.x         , y: objectA.y                         },
        { x: objectA.x        , y: objectA.y + LYmin                 },
        { x: objectA.x + mid  , y: objectA.y + LYmin                 },
        { x: objectB.x - mid  , y: objectB.y - LYmin                 },
        { x: objectB.x        , y: objectB.y - LYmin                 },
        { x: objectB.x        , y: objectB.y          , hasArrow:true},
      ]
    }

    connectTreeYPoint(svgId , points);
  }





  function chartTreeY_buildTree(data, parentId = 0) {
    return data
            .filter(item => item.parent === parentId)
            .map(item => ({
              ...item,
              children: chartTreeY_buildTree(data, item.id)
            }));
  }

  function chartTreeY_assignPositions(node, depth = 0, colCounter = { value: 1 }) {
    node.row = depth;

    if (node.children.length === 0) {
      // Ø¨Ø±Ú¯ â†’ Ø³ØªÙˆÙ† Ù¾Ø´Øª Ø³Ø± Ù‡Ù… Ø¨Ø§ ÙØ§ØµÙ„Ù‡ 2
      node.col = colCounter.value;
      colCounter.value += 2;
    } else {
      node.children.forEach(child => chartTreeY_assignPositions(child, depth + 1, colCounter));
      const minCol = node.children[0].col;
      const maxCol = node.children[node.children.length - 1].col;
      node.col = Math.floor((minCol + maxCol) / 2);
    }
  }

  function chartTreeY_flatten(tree, out = []) {
    tree.forEach(node => {
      out.push(node);
      chartTreeY_flatten(node.children, out);
    });
    return out;
  }

  function chartTreeY_getPosition(objects , templateOptions) {
    const Width =   templateOptions.hasOwnProperty("W")  ? templateOptions.W  : 100;
    const Height =  templateOptions.hasOwnProperty("H")  ? templateOptions.H  : 100;
    const h =       templateOptions.hasOwnProperty("h")  ? templateOptions.h  : 30;
    const dHeight = templateOptions.hasOwnProperty("dH") ? templateOptions.dH : 50;

    for (let i = 0; i < objects.length ; i++) {
      const itemObject = objects[i];
      if (itemObject.hasOwnProperty("row") && itemObject.hasOwnProperty("col")){
        objects[i].x = itemObject.col*(Width) + ((Width)/2);
        objects[i].y = (itemObject.row)*(Height+2*dHeight) + (dHeight + h);
      }
    }
    return objects;
  }

  function chartTreeY_getTemplate(objects , template) {

    for (let i = 0; i < objects.length ; i++) {
      const itemObject = objects[i];
      const tags = itemObject.hasOwnProperty("tags") ? itemObject.tags : {};

      objects[i].template = template.replace(/{{(.*?)}}/g, (match, key) => {
        return tags[key.trim()] ?? "";
      });

    }
    return objects;
  }

  function chartTreeY_drawShape(svgId , objects , templateOptions) {
    const Width = templateOptions.hasOwnProperty("W") ? templateOptions.W : 100;
    const Height = templateOptions.hasOwnProperty("H") ? templateOptions.H : 100;


    for (let i = 0; i < objects.length ; i++) {
      const itemObject = objects[i];
      if (itemObject.hasOwnProperty("template") && itemObject.hasOwnProperty("x") && itemObject.hasOwnProperty("y")){
        const template = itemObject.template;
        const x = itemObject.x;
        const y = itemObject.y;

        createHtmlOnPoint(
                svgId,
                template ,
                { x: x-(Width/2) , y: y  , width:Width+5 , height:Height+5}
        )
      }
    }
    return objects;
  }

  function chartTreeY_drawLine(svgId , objects , templateOptions) {
    const Height = templateOptions.hasOwnProperty("H") ? templateOptions.H : 100;
    const h = templateOptions.hasOwnProperty("h") ? templateOptions.h : 30;
    const dH = templateOptions.hasOwnProperty("dH") ? templateOptions.dH : 50;

    for (let i = 0; i < objects.length ; i++) {
      const itemObject = objects[i];
      if (itemObject.hasOwnProperty("x") && itemObject.hasOwnProperty("y") && itemObject.hasOwnProperty("children")){
        const children = itemObject.children;
        const positionX1 = itemObject.x;
        const positionY1 = itemObject.y + Height // - h + dH + Height + 10 //- Height/2// - h + Height + dH;

        for (let j = 0; j < children.length; j++) {
          const itemChild = children[j];
          if (itemChild.hasOwnProperty("x") && itemChild.hasOwnProperty("y")){
            const positionX2 = itemChild.x;
            const positionY2 = itemChild.y - 10 ///- dH - h + 10 //+ Height/2//- h  + dH + 10;

            connectTwoPointWithTreeHierarchy(
                    svgId ,
                    {x: positionX1 , y:positionY1} ,
                    {x: positionX2 , y:positionY2} ,
            );
          }

        }

      }
    }
    return objects;
  }

  function chartTreeY_init(svgId , template , templateOptions, objects){

    const tree = chartTreeY_buildTree(objects);
    chartTreeY_assignPositions(tree[0]);
    objects = chartTreeY_flatten(tree);
    objects = chartTreeY_getPosition(objects , templateOptions);
    objects = chartTreeY_getTemplate(objects , template);
    objects = chartTreeY_drawShape(svgId , objects , templateOptions);
    objects = chartTreeY_drawLine(svgId , objects , templateOptions);

    console.log(objects)
  }



  chartTreeY_init(
          "mysvg" ,
          `<div style="border: 3px solid black; width:100px;border-radius: 100%; line-height: 100px; height:100px;text-align: center">{{charName}}</div>` ,
          { W: 100 , H:100 , h:30 , dH:30 } ,
          [
            {id:1, parent:0, tags:{charName:"A"}},
            {id:2, parent:1, tags:{charName:"B"}},
            {id:3, parent:1, tags:{charName:"C"}},
            {id:4, parent:2, tags:{charName:"D"}},
            {id:5, parent:2, tags:{charName:"E"}},
            {id:6, parent:2, tags:{charName:"F"}},
            {id:7, parent:2, tags:{charName:"G"}},
            {id:8, parent:3, tags:{charName:"H"}},
            {id:9, parent:3, tags:{charName:"k"}},
            {id:10, parent:9, tags:{charName:"m"}},
            {id:11, parent:9, tags:{charName:"m"}},
            {id:11, parent:6, tags:{charName:"m"}},
          ]
  );

</script>


